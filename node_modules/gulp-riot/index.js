var through = require('through2')
var gutil = require('gulp-util')
var compile = require('riot/compiler')
var PluginError = gutil.PluginError

const PLUGIN_NAME = 'gulp-riot'

function gulpRiot(opts) {
  // Default to compact output
  opts = opts || {
    compact: true
  }

  var stream = through.obj( function( file, enc, callback ) {
    if ( file.isStream() ) {
      this.emit( 'error', new PluginError( PLUGIN_NAME, 'Streams are not supported!' ) )
      return callback()
    }

    if ( file.isBuffer() ) {
      var compiledTag = compile( file.contents.toString( 'utf8' ), opts )
      compiledTag = new Buffer( compiledTag )
      file.contents = compiledTag
    }

    this.push( file )

    callback()
  })

  return stream
}

module.exports = gulpRiot